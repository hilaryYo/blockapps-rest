"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _jsonwebtoken=_interopRequireDefault(require("jsonwebtoken")),_simpleOauth=_interopRequireDefault(require("simple-oauth2")),_unixTime=_interopRequireDefault(require("unix-time")),_syncRequest=_interopRequireDefault(require("sync-request")),_rsaPemFromModExp=_interopRequireDefault(require("rsa-pem-from-mod-exp"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function asyncGeneratorStep(e,t,o,n,r,i,a){try{var s=e[i](a),c=s.value}catch(e){return void o(e)}s.done?t(c):Promise.resolve(c).then(n,r)}function _asyncToGenerator(s){return function(){var e=this,a=arguments;return new Promise(function(t,o){var n=s.apply(e,a);function r(e){asyncGeneratorStep(n,t,o,r,i,"next",e)}function i(e){asyncGeneratorStep(n,t,o,r,i,"throw",e)}r(void 0)})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var o=0;o<t.length;o++){var n=t[o];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,o){return t&&_defineProperties(e.prototype,t),o&&_defineProperties(e,o),e}require("@babel/polyfill");var OAuthUtil=function(){function n(e){_classCallCheck(this,n),this.appTokenCookieName=e.appTokenCookieName,this.appTokenExpirationCookieName=e.appTokenCookieName+"_expiry",this.appTokenCookieMaxAge=e.appTokenCookieMaxAge,this.refreshTokenCookieName=e.appTokenCookieName+"_refresh",this.clientId=e.clientId,this.clientSecret=e.clientSecret,this.redirectUri=e.redirectUri,this.openIdDiscoveryUrl=e.openIdDiscoveryUrl,this.logoutRedirectUri=e.logoutRedirectUri,this.scope=e.scope||"email openid",this.openIdConfig,this.jwtAlgorithm,this.issuer,this.logOutUrl,this.keys=[],this.tokenField=e.tokenField?e.tokenField:"access_token",this.serviceUsername=e.serviceUsername,this.servicePassword=e.servicePassword;var t=this.openIdDiscoveryUrl.split("/");this.tokenHost=t[0]+"//"+t[2]}var o,t,r,e,i;return _createClass(n,[{key:"getOpenIdConfig",value:function(){try{var e=(0,_syncRequest.default)("GET",this.openIdDiscoveryUrl).getBody("utf8");if(this.openIdConfig=JSON.parse(e),this.jwtAlgorithm=this.openIdConfig.id_token_signing_alg_values_supported,this.issuer=this.openIdConfig.issuer,this.logOutUrl=this.openIdConfig.end_session_endpoint,this.openIdConfig.jwks_uri){var t=(0,_syncRequest.default)("GET",this.openIdConfig.jwks_uri).getBody("utf8");this.keys=JSON.parse(t).keys}}catch(e){throw e}}},{key:"getSigninURL",value:function(e){return this.oauth2.authorizationCode.authorizeURL({redirect_uri:this.redirectUri,scope:this.scope,state:e||""})}},{key:"getAccessTokenByAuthCode",value:(i=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var o,n,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return o={code:t,redirect_uri:this.redirectUri,scope:this.scope},e.next=3,this.oauth2.authorizationCode.getToken(o);case 3:return n=e.sent,r=this.oauth2.accessToken.create(n),e.abrupt("return",r);case 6:case"end":return e.stop()}},e,this)})),function(e){return i.apply(this,arguments)})},{key:"getAccessTokenByClientSecret",value:(e=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,o,n,r,i,a,s,c,u=arguments;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=0<u.length&&void 0!==u[0]?u[0]:void 0,o=1<u.length&&void 0!==u[1]?u[1]:void 0,n={scope:(2<u.length&&void 0!==u[2]?u[2]:void 0)||this.scope},t&&o)return i={client:{id:t,secret:o},auth:{tokenHost:this.tokenHost,tokenPath:this.openIdConfig.token_endpoint,authorizePath:this.openIdConfig.authorization_endpoint}},a=_simpleOauth.default.create(i),e.next=9,a.clientCredentials.getToken(n);e.next=15;break;case 9:return s=e.sent,e.next=12,a.accessToken.create(s);case 12:r=e.sent,e.next=19;break;case 15:return e.next=17,this.oauth2.clientCredentials.getToken(n);case 17:c=e.sent,r=this.oauth2.accessToken.create(c);case 19:return e.abrupt("return",r);case 20:case"end":return e.stop()}},e,this)})),function(){return e.apply(this,arguments)})},{key:"getAccessTokenByResourceOwnerCredential",value:(r=_asyncToGenerator(regeneratorRuntime.mark(function e(t,o,n){var r,i,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r={username:t||this.serviceUsername,password:o||this.servicePassword,scope:n||this.scope},e.next=3,this.oauth2.ownerPassword.getToken(r);case 3:return i=e.sent,a=this.oauth2.accessToken.create(i),e.abrupt("return",a);case 6:case"end":return e.stop()}},e,this)})),function(e,t,o){return r.apply(this,arguments)})},{key:"isTokenValid",value:function(e){var t=_jsonwebtoken.default.decode(e,{complete:!0});switch(t.header.alg){case"RS256":var o=this.keys.find(function(e){return e.kid==t.header.kid&&e.x5t==t.header.x5t});try{var n="";o.x5c&&(n="-----BEGIN CERTIFICATE-----\n".concat(o.x5c[0],"\n-----END CERTIFICATE-----")),o.n&&o.e&&(n=(0,_rsaPemFromModExp.default)(o.n,o.e));_jsonwebtoken.default.verify(e,n,{ignoreExpiration:!1});return!0}catch(e){return console.log(e),!1}case"HS256":try{_jsonwebtoken.default.verify(e,this.clientSecret,{ignoreExpiration:!1});return!0}catch(e){return!1}default:return!1}}},{key:"isTokenExpired",value:function(e,t){return t?t<=(0,_unixTime.default)(new Date):_jsonwebtoken.default.decode(e).exp<=(0,_unixTime.default)(new Date)}},{key:"refreshToken",value:(t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var o,n;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return o=this.oauth2.accessToken.create(t),e.next=3,o.refresh();case 3:return n=e.sent,e.abrupt("return",n);case 5:case"end":return e.stop()}},e,this)})),function(e){return t.apply(this,arguments)})},{key:"validateAndGetNewToken",value:(o=_asyncToGenerator(regeneratorRuntime.mark(function e(t,o){var n,r,i,a,s,c;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,n=t.cookies[this.appTokenCookieName]?t.cookies[this.appTokenCookieName]:null){e.next=4;break}throw new Error("Access Token not found");case 4:if(r=t.cookies[this.refreshTokenCookieName]?t.cookies[this.refreshTokenCookieName]:null,i=t.cookies[this.appTokenExpirationCookieName]?t.cookies[this.appTokenExpirationCookieName]:null,this.isTokenExpired(n,i)){e.next=9;break}return e.abrupt("return");case 9:if(r){e.next=13;break}throw o.clearCookie(this.appTokenCookieName),o.clearCookie(this.appTokenExpirationCookieName),new Error("Refresh Token not found");case 13:return a={access_token:n,refresh_token:r},e.next=16,this.refreshToken(a);case 16:return s=e.sent,c=_jsonwebtoken.default.decode(s.token[this.tokenField]),t.cookies[this.appTokenCookieName]=s.token[this.tokenField],t.cookies[this.appTokenExpirationCookieName]=c.exp,t.cookies[this.refreshTokenCookieName]=s.token.refresh_token,o.cookie(this.appTokenCookieName,s.token[this.tokenField],{maxAge:this.appTokenCookieMaxAge,httpOnly:!0}),o.cookie(this.appTokenExpirationCookieName,c.exp,{maxAge:this.appTokenCookieMaxAge,httpOnly:!0}),o.cookie(this.refreshTokenCookieName,s.token.refresh_token,{maxAge:this.appTokenCookieMaxAge,httpOnly:!0}),e.abrupt("return");case 27:throw e.prev=27,e.t0=e.catch(0),e.t0;case 30:case"end":return e.stop()}},e,this,[[0,27]])})),function(e,t){return o.apply(this,arguments)})},{key:"getLogOutUrl",value:function(){return"".concat(this.logOutUrl,"?client_id=").concat(this.clientId,"&post_logout_redirect_uri=").concat(this.logoutRedirectUri)}},{key:"getCookieNameAccessToken",value:function(){return this.appTokenCookieName}},{key:"getCookieNameAccessTokenExpiry",value:function(){return this.appTokenExpirationCookieName}},{key:"getCookieNameRefreshToken",value:function(){return this.refreshTokenCookieName}}],[{key:"init",value:function(e){try{var t=new n(e);t.getOpenIdConfig();var o={client:{id:t.clientId,secret:t.clientSecret},auth:{tokenHost:t.tokenHost,tokenPath:t.openIdConfig.token_endpoint,authorizePath:t.openIdConfig.authorization_endpoint}};return t.oauth2=_simpleOauth.default.create(o),t}catch(e){throw e}}}]),n}(),_default=OAuthUtil;exports.default=_default;
//# sourceMappingURL=oauth.util.js.map
